name: Deploy Production

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    concurrency:
      group: production_deploy
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_PROD_HOST }}
          username: ${{ secrets.VPS_PROD_USER }}
          key: ${{ secrets.VPS_PROD_SSH_KEY }}
          script: |
            cd /home/${{ secrets.VPS_PROD_USER }}/sevra-prod

            # Save current state for rollback
            grep "IMAGE_TAG=" .env > .env.bak || true

            # 1. Take Backup
            TIMESTAMP=$(date +%Y%m%d%H%M%S)
            echo "Taking database backup..."
            # Using env -i to avoid environment pollution and specifically passing what's needed
            set -a
            source .env
            set +a
            docker compose exec -t postgres pg_dump -U "$DB_USER" "$DB_NAME" > "./backups/pre-deploy-$TIMESTAMP.sql"

            # 2. Update to new image tag
            sed -i "s|IMAGE_TAG=.*|IMAGE_TAG=ghcr.io/${{ github.repository }}:${{ github.ref_name }}|g" .env
            docker compose pull app worker

            # 3. Run migrations
            echo "Running migrations..."
            docker compose run --rm app npx prisma migrate deploy

            # 4. Start services
            echo "Restarting services..."
            docker compose up -d

            # 5. Polling Health Check
            echo "Performing health check..."
            MAX_RETRIES=15
            RETRY_COUNT=0
            HEALTHY=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -s http://localhost:3000/api/v1/health | grep '"status":"OK"'; then
                HEALTHY=true
                break
              fi
              echo "Waiting for healthy state... ($((RETRY_COUNT+1))/$MAX_RETRIES)"
              sleep 10
              RETRY_COUNT=$((RETRY_COUNT+1))
            done

            if [ "$HEALTHY" = false ]; then
              echo "Smoke test failed! ROLLING BACK..."
              if [ -f .env.bak ]; then
                mv .env.bak .env
                docker compose pull app worker
                docker compose up -d
                echo "Rollback to previous tag completed."
              else
                echo "No backup .env found, cannot rollback automatically."
              fi
              exit 1
            fi

            echo "Production deployment successful!"
            rm -f .env.bak
