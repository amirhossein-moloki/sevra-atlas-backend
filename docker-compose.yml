version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: jules
      POSTGRES_PASSWORD: password
      POSTGRES_DB: sevra_atlas
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backups/sevra/wal:/var/backups/sevra/wal

  redis_cache:
    image: redis:7-alpine
    command: >
      redis-server
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru
      --slowlog-log-slower-than 10000
    ports:
      - "6379:6379"
    volumes:
      - redis_cache_data:/data

  redis_queue:
    image: redis:7-alpine
    command: >
      redis-server
      --appendonly yes
      --appendfsync everysec
      --maxmemory 512mb
      --maxmemory-policy noeviction
      --slowlog-log-slower-than 10000
      --latency-monitor-threshold 100
    ports:
      - "6380:6379"
    volumes:
      - redis_queue_data:/data

  app:
    build: .
    environment:
      - DATABASE_URL=postgresql://jules:password@postgres:5432/sevra_atlas?schema=public
      - REDIS_URL=redis://redis_cache:6379
      - REDIS_QUEUE_URL=redis://redis_queue:6379
      - IS_WORKER=false
    ports:
      - "3000:3000"
    depends_on:
      - postgres
      - redis_cache
      - redis_queue

  worker:
    build: .
    environment:
      - DATABASE_URL=postgresql://jules:password@postgres:5432/sevra_atlas?schema=public
      - REDIS_URL=redis://redis_cache:6379
      - REDIS_QUEUE_URL=redis://redis_queue:6379
      - IS_WORKER=true
    depends_on:
      - postgres
      - redis_cache
      - redis_queue

volumes:
  postgres_data:
  redis_cache_data:
  redis_queue_data:
