// schema.prisma
// Unified SEO-first Directory + Blog CMS schema
// DB: PostgreSQL | Prisma Client JS

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url = "file:./test.db"
}

//////////////////////
// --- Enums (Blog) ---
//////////////////////











/////////////////////////////
// --- Enums (Directory) ---
/////////////////////////////





























//////////////////////
// --- Models (Auth) ---
//////////////////////

model User {
  id              BigInt   @id @default(autoincrement())
  username        String   @unique
  firstName       String   @map("first_name")
  lastName        String   @map("last_name")
  email           String
  isStaff         Boolean  @map("is_staff")
  isActive        Boolean  @map("is_active")
  dateJoined      DateTime @map("date_joined") @default(now())

  phoneNumber     String   @unique @map("phone_number")
  isPhoneVerified Boolean  @default(false) @map("is_phone_verified")

  profilePicture  String?  @map("profile_picture")
  score           Int      @default(0)
  referralCode    String   @unique @map("referral_code")

  // Directory fields
  role String          @default(USER)
  status String     @default(ACTIVE)
  verification String @default(NONE)
  gender String            @default(UNSPECIFIED)
  bio             String?

  cityId          BigInt?
  city            City?             @relation(fields: [cityId], references: [id], onDelete: SetNull)

  lastLoginAt     DateTime?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  // Blog relations
  authorProfile AuthorProfile?
  uploadedMedia Media[]        @relation("MediaUploader")
  revisions     Revision[]
  comments      Comment[]
  reactions     Reaction[]

  // Directory relations
  salons          Salon[]        @relation("SalonOwners")
  artists         Artist[]       @relation("ArtistOwners")
  reviews         Review[]
  reviewVotes     ReviewVote[]
  reports         Report[]
  follows         Follow[]
  saves           Save[]
  otpAttempts     OtpAttempt[]
  verificationReviewed VerificationRequest[] @relation("VerificationReviewedBy")

  primarySalons   Salon[]        @relation("PrimarySalonOwner")
  primaryArtists  Artist[]       @relation("PrimaryArtistOwner")
  verifiedCertifications ArtistCertification[] @relation("CertVerifier")
  verificationRequests VerificationRequest[] @relation("VerificationRequester")
  refreshTokens   RefreshToken[] @relation("UserRefreshTokens")

  @@map("users_user")
  @@index([cityId])
  @@index([role, status])
}

model OtpAttempt {
  id        BigInt   @id @default(autoincrement())
  phoneE164 String    // store normalized (+98...)
  ip        String?
  userAgent String?
  purpose   String
  success   Boolean  @default(false)
  createdAt DateTime @default(now())

  userId    BigInt?
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([phoneE164, createdAt])
  @@index([userId, createdAt])
}

////////////////////////
// --- Models (Media) ---
////////////////////////

model Media {
  id         BigInt   @id @default(autoincrement())
  storageKey String   @map("storage_key")
  url        String
  type       String
  mime       String
  width      Int?
  height     Int?
  duration   Int?
  sizeBytes  Int      @default(0) @map("size_bytes")
  altText    String   @default("") @map("alt_text")
  title      String   @default("")
  uploadedBy BigInt?  @map("uploaded_by_id")
  createdAt  DateTime @default(now()) @map("created_at")
  deletedAt  DateTime? @map("deleted_at")

  // Directory SEO helpers (optional)
  kind String?   // AVATAR/COVER/CERTIFICATE/...
  entityType String?  // SALON/ARTIST/...
  entityId   BigInt?      // polymorphic FK (enforced in app / migration)

  // Relations
  uploader       User?           @relation("MediaUploader", fields: [uploadedBy], references: [id], onDelete: SetNull)
  profiles       AuthorProfile[]
  postCovers     Post[]          @relation("PostCover")
  postOgImages   Post[]          @relation("PostOgImage")
  attachments    PostMedia[]

  seoOgImages      SeoMeta[]     @relation("SeoOgImage")
  seoTwitterImages SeoMeta[]     @relation("SeoTwitterImage")

  // Directory relations
  salonAvatars   Salon[]         @relation("SalonAvatar")
  salonCovers    Salon[]         @relation("SalonCover")
  artistAvatars  Artist[]        @relation("ArtistAvatar")
  artistCovers   Artist[]        @relation("ArtistCover")
  verificationDocs VerificationDocument[]
  artistCertMedia ArtistCertification[] @relation("ArtistCertMedia")

  @@map("blog_media")
  @@index([uploadedBy])
  @@index([createdAt])
  @@index([entityType, entityId])
}

/////////////////////////
// --- Blog CMS Models ---
/////////////////////////

model AuthorProfile {
  userId      BigInt  @id @map("user_id")
  displayName String  @map("display_name")
  bio         String
  avatarId    BigInt? @map("avatar_id")

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  avatar Media? @relation(fields: [avatarId], references: [id], onDelete: SetNull)
  posts  Post[]

  @@map("blog_authorprofile")
  @@index([avatarId])
}

model Category {
  id          BigInt  @id @default(autoincrement())
  slug        String  @unique
  name        String
  parentId    BigInt? @map("parent_id")
  description String
  order       Int     @default(0)

  // SEO link (optional)
  seoMetaId   BigInt?
  seoMeta     SeoMeta? @relation(fields: [seoMetaId], references: [id], onDelete: SetNull)

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Category[] @relation("CategoryHierarchy")
  posts    Post[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("blog_category")
  @@index([parentId])
  @@index([order])
  @@index([seoMetaId])
}

model Tag {
  id          BigInt @id @default(autoincrement())
  slug        String @unique
  name        String
  description String

  posts PostTag[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("blog_tag")
}

model Series {
  id            BigInt        @id @default(autoincrement())
  slug          String        @unique
  title         String
  description   String
  orderStrategy String @default(manual) @map("order_strategy")

  posts Post[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("blog_series")
  @@index([orderStrategy])
}

model Post {
  id             BigInt         @id @default(autoincrement())
  slug           String         @unique
  canonicalUrl   String?        @map("canonical_url")
  title          String
  excerpt        String
  isHot          Boolean        @default(false) @map("is_hot")
  content        String
  readingTimeSec Int            @default(0) @map("reading_time_sec")
  status String     @default(draft)
  visibility String @default(public)
  publishedAt    DateTime?      @map("published_at")
  scheduledAt    DateTime?      @map("scheduled_at")
  authorId       BigInt         @map("author_id")
  categoryId     BigInt?        @map("category_id")
  seriesId       BigInt?        @map("series_id")
  coverMediaId   BigInt?        @map("cover_media_id")
  ogImageId      BigInt?        @map("og_image_id")
  seoTitle       String         @default("") @map("seo_title")
  seoDescription String         @default("") @map("seo_description")
  viewsCount     Int            @default(0) @map("views_count")

  // Optional SEO meta (if you want central control beyond seoTitle/seoDescription)
  seoMetaId      BigInt?
  seoMeta        SeoMeta?       @relation(fields: [seoMetaId], references: [id], onDelete: SetNull)

  author           AuthorProfile @relation(fields: [authorId], references: [userId], onDelete: Cascade)
  category         Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  series           Series?       @relation(fields: [seriesId], references: [id], onDelete: SetNull)
  coverMedia       Media?        @relation("PostCover", fields: [coverMediaId], references: [id], onDelete: SetNull)
  ogImage          Media?        @relation("PostOgImage", fields: [ogImageId], references: [id], onDelete: SetNull)
  tags             PostTag[]
  revisions        Revision[]
  comments         Comment[]
  mediaAttachments PostMedia[]

  // Directory signals
  saves            Save[]        @relation("SaveBlogPost")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("blog_post")
  @@index([publishedAt])
  @@index([status, visibility, publishedAt])
  @@index([authorId, publishedAt])
  @@index([categoryId, publishedAt])
  @@index([seriesId, publishedAt])
  @@index([scheduledAt])
  @@index([isHot])
  @@index([seoMetaId])
}

model PostTag {
  id        BigInt   @id @default(autoincrement())
  postId    BigInt   @map("post_id")
  tagId     BigInt   @map("tag_id")
  createdAt DateTime @default(now()) @map("created_at")

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@map("blog_posttag")
  @@index([tagId])
  @@index([postId])
}

model Revision {
  id         BigInt   @id @default(autoincrement())
  postId     BigInt   @map("post_id")
  editorId   BigInt?  @map("editor_id")
  content    String
  title      String
  excerpt    String
  changeNote String   @default("") @map("change_note")
  createdAt  DateTime @default(now()) @map("created_at")

  post   Post  @relation(fields: [postId], references: [id], onDelete: Cascade)
  editor User? @relation(fields: [editorId], references: [id], onDelete: SetNull)

  @@map("blog_revision")
  @@index([postId, createdAt])
  @@index([editorId, createdAt])
}

model Comment {
  id        BigInt        @id @default(autoincrement())
  postId    BigInt        @map("post_id")
  userId    BigInt        @map("user_id")
  parentId  BigInt?       @map("parent_id")
  content   String
  status String @default(pending)
  createdAt DateTime      @default(now()) @map("created_at")
  ip        String?
  userAgent String        @default("") @map("user_agent")

  post    Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")

  deletedAt DateTime? @map("deleted_at")

  @@map("blog_comment")
  @@index([postId, createdAt])
  @@index([status, createdAt])
  @@index([parentId])
}

model Reaction {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt   @map("user_id")
  reaction  String
  createdAt DateTime @default(now()) @map("created_at")

  // Polymorphic
  contentTypeId Int    @map("content_type_id")
  objectId      BigInt @map("object_id")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, contentTypeId, objectId, reaction])
  @@map("blog_reaction")
  @@index([contentTypeId, objectId])
  @@index([userId, createdAt])
}

model Page {
  id             BigInt     @id @default(autoincrement())
  slug           String     @unique
  title          String
  content        String
  status String @default(draft)
  publishedAt    DateTime?  @map("published_at")
  seoTitle       String     @default("") @map("seo_title")
  seoDescription String     @default("") @map("seo_description")

  seoMetaId      BigInt?
  seoMeta        SeoMeta?   @relation(fields: [seoMetaId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("blog_page")
  @@index([status, publishedAt])
  @@index([seoMetaId])
}

model Menu {
  id       BigInt       @id @default(autoincrement())
  name     String
  location String @unique

  items MenuItem[]

  @@map("blog_menu")
}

model MenuItem {
  id          BigInt  @id @default(autoincrement())
  menuId      BigInt  @map("menu_id")
  parentId    BigInt? @map("parent_id")
  label       String
  url         String
  order       Int     @default(0)
  targetBlank Boolean @default(false) @map("target_blank")

  menu     Menu      @relation(fields: [menuId], references: [id], onDelete: Cascade)
  parent   MenuItem? @relation("MenuItemHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children MenuItem[] @relation("MenuItemHierarchy")

  @@map("blog_menuitem")
  @@index([menuId, order])
  @@index([parentId])
}

model PostMedia {
  id             BigInt @id @default(autoincrement())
  postId         BigInt @map("post_id")
  mediaId        BigInt @map("media_id")
  attachmentType String @default("in-content") @map("attachment_type")

  post  Post  @relation(fields: [postId], references: [id], onDelete: Cascade)
  media Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  @@unique([postId, mediaId, attachmentType])
  @@map("blog_postmedia")
  @@index([mediaId])
  @@index([postId])
}

/////////////////////////////
// --- SEO infra (global) ---
/////////////////////////////

model SeoMeta {
  id              BigInt        @id @default(autoincrement())
  entityType String
  entityId        BigInt

  // Relations (back-references)
  category        Category[]
  post            Post[]
  page            Page[]
  province        Province[]
  city            City[]
  salon           Salon[]
  artist          Artist[]

  title           String?
  description     String?
  canonicalMode String @default(SELF)
  canonicalUrl    String?
  robots String   @default(INDEX_FOLLOW)

  ogTitle         String?
  ogDescription   String?
  ogImageMediaId  BigInt?
  ogImage         Media?        @relation("SeoOgImage", fields: [ogImageMediaId], references: [id], onDelete: SetNull)

  twitterTitle    String?
  twitterDesc     String?
  twitterImageMediaId BigInt?
  twitterImage    Media?        @relation("SeoTwitterImage", fields: [twitterImageMediaId], references: [id], onDelete: SetNull)

  h1              String?
  breadcrumbLabel String?

  updatedAt       DateTime      @updatedAt
  createdAt       DateTime      @default(now())

  @@unique([entityType, entityId])
  @@index([entityType])
}

model SlugHistory {
  id         BigInt     @id @default(autoincrement())
  entityType String
  entityId   BigInt
  oldSlug    String
  newSlug    String
  changedAt  DateTime   @default(now())

  @@index([entityType, oldSlug])
  @@index([entityType, entityId, changedAt])
}

model RedirectRule {
  id          BigInt       @id @default(autoincrement())
  fromPath    String       @unique
  toPath      String
  type String @default(PERMANENT_301)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([isActive])
}

model SitemapUrl {
  id          BigInt             @id @default(autoincrement())
  path        String             @unique
  entityType String?
  entityId    BigInt?
  lastmod     DateTime?
  changefreq String? @default(WEEKLY)
  priority    Float?
  isEnabled   Boolean            @default(true)

  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@index([isEnabled])
  @@index([entityType, entityId])
}

////////////////////////////
// --- Geography (Local) ---
////////////////////////////

model Province {
  id        BigInt  @id @default(autoincrement())
  nameFa    String
  nameEn    String?
  slug      String  @unique

  seoMetaId BigInt?
  seoMeta   SeoMeta? @relation(fields: [seoMetaId], references: [id], onDelete: SetNull)

  cities    City[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([nameFa])
  @@index([seoMetaId])
}

model City {
  id        BigInt  @id @default(autoincrement())
  provinceId BigInt
  province  Province @relation(fields: [provinceId], references: [id], onDelete: Cascade)

  nameFa    String
  nameEn    String?
  slug      String

  lat       Float?
  lng       Float?

  isLandingEnabled Boolean @default(true)
  landingIntro     String?

  seoMetaId BigInt?
  seoMeta   SeoMeta? @relation(fields: [seoMetaId], references: [id], onDelete: SetNull)

  neighborhoods Neighborhood[]
  users     User[]
  salons    Salon[]
  artists   Artist[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provinceId, slug])
  @@index([nameFa])
  @@index([seoMetaId])
}

model Neighborhood {
  id      BigInt @id @default(autoincrement())
  cityId  BigInt
  city    City   @relation(fields: [cityId], references: [id], onDelete: Cascade)

  nameFa  String
  slug    String

  salons  Salon[]
  artists Artist[]

  @@unique([cityId, slug])
  @@index([cityId])
}

////////////////////////////////////
// --- Directory: Salon / Artist ---
////////////////////////////////////

model Salon {
  id            BigInt  @id @default(autoincrement())
  name          String
  slug          String  @unique  // /salon/{slug}

  summary       String?
  description   String?

  phone         String?
  instagram     String?
  website       String?

  provinceId    BigInt?
  cityId        BigInt?
  neighborhoodId BigInt?

  city          City?         @relation(fields: [cityId], references: [id], onDelete: SetNull)
  neighborhood  Neighborhood? @relation(fields: [neighborhoodId], references: [id], onDelete: SetNull)

  addressLine   String?
  postalCode    String?
  lat           Float?
  lng           Float?

  openingHoursId BigInt?
  openingHours   OpeningHours? @relation(fields: [openingHoursId], references: [id], onDelete: SetNull)

  isWomenOnly   Boolean?
  priceTier     Int?

  avatarMediaId BigInt?
  coverMediaId  BigInt?
  avatar        Media? @relation("SalonAvatar", fields: [avatarMediaId], references: [id], onDelete: SetNull)
  cover         Media? @relation("SalonCover", fields: [coverMediaId], references: [id], onDelete: SetNull)

  seoMetaId     BigInt?
  seoMeta       SeoMeta? @relation(fields: [seoMetaId], references: [id], onDelete: SetNull)

  verification String @default(NONE)
  status String      @default(ACTIVE)

  // ownership
  owners        User[]  @relation("SalonOwners")
  primaryOwnerId BigInt?
  primaryOwner   User?  @relation("PrimarySalonOwner", fields: [primaryOwnerId], references: [id], onDelete: SetNull)

  // relations
  salonArtists    SalonArtist[]
  services        SalonService[]
  reviews         Review[] @relation("SalonReviews")
  saves           Save[]   @relation("SaveSalon")
  follows         Follow[] @relation("FollowSalon")
  reports         Report[] @relation("SalonReports")
  verificationReq VerificationRequest?

  avgRating     Float @default(0)
  reviewCount   Int   @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  @@index([cityId, neighborhoodId, status])
  @@index([verification])
  @@index([seoMetaId])
}

model OpeningHours {
  id        BigInt  @id @default(autoincrement())
  weeklyJson String
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())

  salons    Salon[]
}

model Artist {
  id            BigInt  @id @default(autoincrement())
  fullName      String
  slug          String  @unique  // /artist/{slug}

  summary       String?
  bio           String?

  phone         String?
  instagram     String?
  website       String?

  cityId        BigInt?
  neighborhoodId BigInt?
  city          City?         @relation(fields: [cityId], references: [id], onDelete: SetNull)
  neighborhood  Neighborhood? @relation(fields: [neighborhoodId], references: [id], onDelete: SetNull)

  avatarMediaId BigInt?
  coverMediaId  BigInt?
  avatar        Media? @relation("ArtistAvatar", fields: [avatarMediaId], references: [id], onDelete: SetNull)
  cover         Media? @relation("ArtistCover", fields: [coverMediaId], references: [id], onDelete: SetNull)

  seoMetaId     BigInt?
  seoMeta       SeoMeta? @relation(fields: [seoMetaId], references: [id], onDelete: SetNull)

  verification String @default(NONE)
  status String      @default(ACTIVE)

  owners        User[]  @relation("ArtistOwners")
  primaryOwnerId BigInt?
  primaryOwner   User?  @relation("PrimaryArtistOwner", fields: [primaryOwnerId], references: [id], onDelete: SetNull)

  specialties     ArtistSpecialty[]
  salonArtists    SalonArtist[]
  reviews         Review[] @relation("ArtistReviews")
  saves           Save[]   @relation("SaveArtist")
  follows         Follow[] @relation("FollowArtist")
  reports         Report[] @relation("ArtistReports")
  verificationReq VerificationRequest?

  // âœ… Certifications (NEW)
  certifications  ArtistCertification[]

  avgRating     Float @default(0)
  reviewCount   Int   @default(0)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?

  @@index([cityId, neighborhoodId, status])
  @@index([verification])
  @@index([seoMetaId])
}

model ArtistCertification {
  id            BigInt  @id @default(autoincrement())
  artistId      BigInt
  artist        Artist  @relation(fields: [artistId], references: [id], onDelete: Cascade)

  title         String    // "Bridal Makeup Masterclass"
  issuer        String    // institute/brand/teacher
  issuerSlug    String?

  category      String?    // Makeup/Hair/Nail/Skin
  level         String?    // Basic/Advanced/Master

  issuedAt      DateTime?
  expiresAt     DateTime?

  credentialId  String?
  credentialUrl String?

  mediaId       BigInt?
  media         Media?  @relation("ArtistCertMedia", fields: [mediaId], references: [id], onDelete: SetNull)

  isVerified    Boolean @default(false)
  verifiedAt    DateTime?
  verifiedById  BigInt?
  verifiedBy    User?   @relation("CertVerifier", fields: [verifiedById], references: [id], onDelete: SetNull)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([artistId])
  @@index([issuerSlug])
  @@index([isVerified])
}

model SalonArtist {
  id        BigInt @id @default(autoincrement())
  salonId   BigInt
  artistId  BigInt

  roleTitle String?
  isActive  Boolean @default(true)
  startedAt DateTime?
  endedAt   DateTime?

  salon     Salon  @relation(fields: [salonId], references: [id], onDelete: Cascade)
  artist    Artist @relation(fields: [artistId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([salonId, artistId])
  @@index([salonId, isActive])
  @@index([artistId, isActive])
}

///////////////////////////////
// --- Directory: Taxonomy ---
///////////////////////////////

model ServiceCategory {
  id      BigInt @id @default(autoincrement())
  nameFa  String
  slug    String @unique
  order   Int    @default(0)

  services ServiceDefinition[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([order])
}

model ServiceDefinition {
  id          BigInt @id @default(autoincrement())
  categoryId  BigInt
  category    ServiceCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  nameFa      String
  slug        String @unique
  description String?

  salonLinks  SalonService[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([categoryId])
}

model SalonService {
  id        BigInt @id @default(autoincrement())
  salonId   BigInt
  serviceId BigInt
  notes     String?

  salon   Salon             @relation(fields: [salonId], references: [id], onDelete: Cascade)
  service ServiceDefinition @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([salonId, serviceId])
  @@index([salonId])
  @@index([serviceId])
}

model Specialty {
  id      BigInt @id @default(autoincrement())
  nameFa  String
  slug    String @unique
  order   Int    @default(0)

  artists ArtistSpecialty[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@index([order])
}

model ArtistSpecialty {
  id          BigInt @id @default(autoincrement())
  artistId    BigInt
  specialtyId BigInt

  artist    Artist    @relation(fields: [artistId], references: [id], onDelete: Cascade)
  specialty Specialty @relation(fields: [specialtyId], references: [id], onDelete: Cascade)

  @@unique([artistId, specialtyId])
  @@index([specialtyId])
}

////////////////////////////
// --- Directory: Reviews ---
////////////////////////////

model Review {
  id        BigInt @id @default(autoincrement())
  authorId  BigInt
  author    User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  salonId   BigInt?
  artistId  BigInt?
  salon     Salon?  @relation("SalonReviews", fields: [salonId], references: [id], onDelete: Cascade)
  artist    Artist? @relation("ArtistReviews", fields: [artistId], references: [id], onDelete: Cascade)

  rating    Int
  title     String?
  body      String?
  status String @default(PUBLISHED)

  visitedAt DateTime?
  ip        String?
  userAgent String?

  likeCount    Int @default(0)
  dislikeCount Int @default(0)

  votes     ReviewVote[]
  reports   Report[] @relation("ReviewReports")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@index([authorId, createdAt])
  @@index([salonId, status, createdAt])
  @@index([artistId, status, createdAt])
}

model ReviewVote {
  id       BigInt @id @default(autoincrement())
  userId   BigInt
  reviewId BigInt
  isLike   Boolean

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  review Review @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, reviewId])
  @@index([reviewId, isLike])
}

model Report {
  id         BigInt @id @default(autoincrement())
  reporterId BigInt
  reporter   User   @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  targetType String
  targetId   BigInt

  salonId    BigInt?
  salon      Salon?  @relation("SalonReports", fields: [salonId], references: [id], onDelete: SetNull)
  artistId   BigInt?
  artist     Artist? @relation("ArtistReports", fields: [artistId], references: [id], onDelete: SetNull)

  reviewId   BigInt?
  review     Review? @relation("ReviewReports", fields: [reviewId], references: [id], onDelete: SetNull)

  reason     String
  details    String?
  status String @default(OPEN)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([targetType, targetId, status])
  @@index([reporterId, createdAt])
}

///////////////////////////////
// --- Directory: Verification ---
///////////////////////////////

model VerificationRequest {
  id            BigInt @id @default(autoincrement())
  requestedById BigInt
  requestedBy   User   @relation("VerificationRequester", fields: [requestedById], references: [id], onDelete: Cascade)

  salonId       BigInt? @unique
  artistId      BigInt? @unique
  salon         Salon?  @relation(fields: [salonId], references: [id], onDelete: Cascade)
  artist        Artist? @relation(fields: [artistId], references: [id], onDelete: Cascade)

  status String @default(PENDING)
  notes         String?

  reviewedById  BigInt?
  reviewedBy    User?   @relation("VerificationReviewedBy", fields: [reviewedById], references: [id], onDelete: SetNull)

  documents     VerificationDocument[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([status, createdAt])
  @@index([requestedById, createdAt])
}

model VerificationDocument {
  id                    BigInt @id @default(autoincrement())
  verificationRequestId BigInt
  verificationRequest   VerificationRequest @relation(fields: [verificationRequestId], references: [id], onDelete: Cascade)

  mediaId               BigInt
  media                 Media @relation(fields: [mediaId], references: [id], onDelete: Cascade)

  label                 String?
  createdAt             DateTime @default(now())

  @@index([verificationRequestId])
  @@index([mediaId])
}

//////////////////////
// --- Models (Auth Fallback) ---
//////////////////////

model Otp {
  id        BigInt   @id @default(autoincrement())
  phoneE164 String   @unique
  code      String
  expiresAt DateTime
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([phoneE164, expiresAt])
  @@map("auth_otp")
}

model RefreshToken {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation("UserRefreshTokens", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("auth_refreshtoken")
}

///////////////////////////////////
// --- Directory: Follow / Save ---
///////////////////////////////////

model Follow {
  id         BigInt @id @default(autoincrement())
  followerId BigInt
  follower   User   @relation(fields: [followerId], references: [id], onDelete: Cascade)

  targetType String
  salonId    BigInt?
  artistId   BigInt?

  salon      Salon?  @relation("FollowSalon", fields: [salonId], references: [id], onDelete: Cascade)
  artist     Artist? @relation("FollowArtist", fields: [artistId], references: [id], onDelete: Cascade)

  createdAt  DateTime @default(now())

  @@unique([followerId, targetType, salonId, artistId])
  @@index([targetType, createdAt])
  @@index([followerId, createdAt])
}

model Save {
  id        BigInt @id @default(autoincrement())
  userId    BigInt
  user      User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  targetType String

  salonId   BigInt?
  artistId  BigInt?
  postId    BigInt?

  salon     Salon?  @relation("SaveSalon", fields: [salonId], references: [id], onDelete: Cascade)
  artist    Artist? @relation("SaveArtist", fields: [artistId], references: [id], onDelete: Cascade)
  post      Post?   @relation("SaveBlogPost", fields: [postId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, targetType, salonId, artistId, postId])
  @@index([userId, createdAt])
  @@index([targetType, createdAt])
}
